{% extends "base.html" %}

{% block title %}Mapa Interactivo - SIMPARH{% endblock %}

{% block content %}
<style>
    /* Ajuste específico para móvil: descontar la altura de la navbar (aprox 60px) */
    @media (max-width: 768px) {
        .full-screen-map-container {
            height: calc(100vh - 60px) !important;
        }
    }
</style>

<div class="full-screen-map-container">
    <div id="map" class="full-h"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // DATOS
        const allEmas = {{ ema_locations | tojson }};
        const owmApiKey = {{ owm_api_key | tojson }};
        
        // MAPA
        const map = L.map('map', { zoomControl: false }).setView([-34.6, -58.8], 9);
        L.control.zoom({ position: 'topright' }).addTo(map);

        const baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
            attribution: '© OpenStreetMap, © CARTO' 
        });
        const rainLayer = L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${owmApiKey}`, { 
            opacity: 0.6 
        });
        
        map.addLayer(baseLayer);
        L.control.layers({ "Mapa Base": baseLayer }, { "Radar Lluvia": rainLayer }, { position: 'topright' }).addTo(map);

        const markersLayer = L.layerGroup().addTo(map);
        
        // ICONOS
        const iconOnline = L.divIcon({ 
            className: 'custom-div-icon', 
            html: '<div style="background-color: #198754; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
            iconSize: [12, 12]
        });

        const iconOffline = L.divIcon({ 
            className: 'custom-div-icon', 
            html: '<div style="background-color: #dc3545; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
            iconSize: [12, 12]
        });

        // REFERENCIAS DOM
        const selPartido = document.getElementById('selectPartido');
        const selCuenca = document.getElementById('selectCuenca');
        const lblCount = document.getElementById('stationsCount');
        const triggers = document.querySelectorAll('.filter-trigger');

        // 1. LLENAR COMBOS
        function populateFilters() {
            const partidos = new Set();
            const cuencas = new Set();

            allEmas.forEach(ema => {
                if(ema.partido) partidos.add(ema.partido);
                if(ema.cuenca) cuencas.add(ema.cuenca);
            });

            // Agregar opción especial "Ver Todas"
            const optAllP = document.createElement('option');
            optAllP.value = 'all'; optAllP.textContent = '-- Ver Todas --';
            optAllP.style.fontWeight = 'bold';
            if(selPartido) selPartido.appendChild(optAllP);

            const optAllC = document.createElement('option');
            optAllC.value = 'all'; optAllC.textContent = '-- Ver Todas --';
            optAllC.style.fontWeight = 'bold';
            if(selCuenca) selCuenca.appendChild(optAllC);

            Array.from(partidos).sort().forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.textContent = p;
                if(selPartido) selPartido.appendChild(opt);
            });

            Array.from(cuencas).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                if(selCuenca) selCuenca.appendChild(opt);
            });
        }

        // 2. LÓGICA DE DIBUJADO Y FILTRADO
        function updateMap() {
            markersLayer.clearLayers(); 
            
            // Los valores pueden ser: "" (blanco), "all" (todas), o un nombre específico
            const pVal = selPartido ? selPartido.value : '';
            const cVal = selCuenca ? selCuenca.value : '';
            
            let count = 0;

            allEmas.forEach(ema => {
                let mostrar = false;

                // --- CASO 1: FILTROS EN BLANCO (INICIO) ---
                if (pVal === '' && cVal === '') {
                    // Mostrar solo Principales
                    if (ema.red === 'COMIREC' || ema.red === 'SIMATH') {
                        mostrar = true;
                    }
                } 
                // --- CASO 2: FILTRO ACTIVADO ("Todas" o Específico) ---
                else {
                    let cumplePartido = true;
                    let cumpleCuenca = true;

                    // Lógica Partido
                    if (pVal !== '' && pVal !== 'all') {
                        if (ema.partido !== pVal) cumplePartido = false;
                    }
                    
                    // Lógica Cuenca
                    if (cVal !== '' && cVal !== 'all') {
                        if (ema.cuenca !== cVal) cumpleCuenca = false;
                    }

                    if (cumplePartido && cumpleCuenca) {
                        mostrar = true;
                    }
                }

                if (mostrar) {
                    const icon = (ema.status === 'online') ? iconOnline : iconOffline;
                    const marker = L.marker([ema.lat, ema.lon], { icon: icon });
                    
                    marker.bindTooltip(ema.nombre, { 
                        permanent: false,
                        direction: 'top',
                        className: 'ema-label', 
                        offset: [0, -10]
                    });
                    
                    marker.on('click', () => openPopup(marker, ema));
                    markersLayer.addLayer(marker);
                    count++;
                }
            });

            if(lblCount) lblCount.textContent = `Viendo ${count} estaciones`;
        }

        function openPopup(marker, ema) {
            // 1. Generamos la URL base usando Jinja (Flask lo procesa antes)
            const baseUrl = "{{ url_for('main.chart_dashboard_page') }}";
        
        // 2. Le pegamos el ID de la estación seleccionada
            const targetUrl = `${baseUrl}?ema_id=${ema.id}`;

        // 3. Usamos esa URL en el botón del popup
            let popupContent = `
                <div style="min-width: 200px;">
                    <h6 class="mb-1">${ema.nombre}</h6>
                    <small class="text-muted d-block mb-2">${ema.id}</small>
                    <hr class="my-2">
                    <div id="popup-sensors-list">
                        <div class="text-center text-muted small">
                            <span class="spinner-border spinner-border-sm"></span> Cargando sensores...
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="d-grid">
                        <a href="${targetUrl}" class="btn btn-sm btn-primary w-100 text-white">
                            <i class="bi bi-speedometer2"></i> Ver Dashboard
                        </a>
                    </div>
                </div>
            `;
            
            const popup = L.popup().setLatLng(marker.getLatLng()).setContent(popupContent).openOn(map);

            fetch(`/api/map-status/${encodeURIComponent(ema.id)}`)
                .then(res => res.json())
                .then(sensores => {
                    let htmlList = '<ul class="list-unstyled mb-0 small">';
                    if (sensores.length === 0) {
                        htmlList += '<li class="text-muted text-center">Sin sensores configurados.</li>';
                    } else {
                        sensores.forEach(s => {
                            const colorClass = s.estado === 'online' ? 'text-success' : 'text-danger';
                            const iconClass = s.estado === 'online' ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
                            htmlList += `
                                <li class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="${colorClass}">
                                        <i class="bi ${iconClass}"></i> ${s.nombre}
                                    </span>
                                    <span class="fw-bold">${s.valor}</span>
                                </li>
                            `;
                        });
                    }
                    htmlList += '</ul>';
                    const container = document.getElementById('popup-sensors-list');
                    if(container) container.innerHTML = htmlList;
                })
                .catch(err => {
                    const container = document.getElementById('popup-sensors-list');
                    if(container) container.innerHTML = '<p class="text-danger small text-center">Error cargando datos.</p>';
                });
        }

        populateFilters();
        updateMap();
        triggers.forEach(t => t.addEventListener('change', updateMap));
    });
</script>
{% endblock %}