{% extends "base.html" %}

{% block title %}Mapa Interactivo - SIMPARH{% endblock %}

{% block content %}
<div class="full-screen-map-container" style="position: relative;">
    
    <div class="card shadow-sm border-0" 
         style="position: absolute; top: 20px; right: 20px; z-index: 1000; width: 300px; background-color: rgba(255, 255, 255, 0.95);">
        <div class="card-header bg-dark text-white py-2">
            <small class="fw-bold"><i class="bi bi-funnel"></i> Filtros de Estaciones</small>
        </div>
        <div class="card-body p-3">
            
            <div class="mb-2">
                <label class="form-label small fw-bold mb-1">Municipio (Partido):</label>
                <select id="selectPartido" class="form-select form-select-sm filter-trigger">
                    <option value="all">-- Todos --</option>
                    </select>
            </div>

            <div class="mb-2">
                <label class="form-label small fw-bold mb-1">Cuenca:</label>
                <select id="selectCuenca" class="form-select form-select-sm filter-trigger">
                    <option value="all">-- Todas --</option>
                    </select>
            </div>

            <hr class="my-2">
            
            <div class="d-flex justify-content-around mb-2">
                <small><span class="badge bg-success">●</span> Online (Hoy)</small>
                <small><span class="badge bg-danger">●</span> Offline</small>
            </div>

            <small class="text-muted d-block text-center" id="stationsCount">Cargando...</small>
        </div>
    </div>

    <div id="map" class="full-h"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // DATOS DESDE FLASK
        const allEmas = {{ ema_locations | tojson }};
        const owmApiKey = {{ owm_api_key | tojson }};
        
        // INICIALIZAR MAPA
        const map = L.map('map').setView([-34.6, -58.8], 9);
        
        const baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
            attribution: '© OpenStreetMap, © CARTO' 
        });
        const rainLayer = L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${owmApiKey}`, { 
            opacity: 0.6 
        });
        
        map.addLayer(baseLayer);
        L.control.layers({ "Mapa Base": baseLayer }, { "Radar Lluvia": rainLayer }).addTo(map);

        // Capa de Marcadores
        const markersLayer = L.layerGroup().addTo(map);
        
        // --- ICONOS (SEMÁFORO) ---
        const iconOnline = L.divIcon({ 
            className: 'custom-div-icon', 
            html: '<div style="background-color: #198754; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
            iconSize: [12, 12]
        });

        const iconOffline = L.divIcon({ 
            className: 'custom-div-icon', 
            html: '<div style="background-color: #dc3545; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
            iconSize: [12, 12]
        });

        // REFERENCIAS DOM
        const selPartido = document.getElementById('selectPartido');
        const selCuenca = document.getElementById('selectCuenca');
        const lblCount = document.getElementById('stationsCount');
        const triggers = document.querySelectorAll('.filter-trigger');

        // 1. LLENAR COMBOS (¡Ahora con TODAS las estaciones!)
        function populateFilters() {
            const partidos = new Set();
            const cuencas = new Set();

            allEmas.forEach(ema => {
                // NO filtramos por red aquí. Agregamos TODO lo que haya en la base.
                if(ema.partido) partidos.add(ema.partido);
                if(ema.cuenca) cuencas.add(ema.cuenca);
            });

            Array.from(partidos).sort().forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.textContent = p;
                selPartido.appendChild(opt);
            });

            Array.from(cuencas).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                selCuenca.appendChild(opt);
            });
        }

        // 2. LÓGICA DE DIBUJADO INTELIGENTE
        function updateMap() {
            markersLayer.clearLayers(); 
            
            const pVal = selPartido.value;
            const cVal = selCuenca.value;
            
            // ¿El usuario está usando algún filtro?
            const filtrosActivos = (pVal !== 'all' || cVal !== 'all');

            let count = 0;

            allEmas.forEach(ema => {
                let mostrar = false;

                // 1. Chequeamos coincidencia con filtros
                const coincidePartido = (pVal === 'all' || ema.partido === pVal);
                const coincideCuenca = (cVal === 'all' || ema.cuenca === cVal);

                if (coincidePartido && coincideCuenca) {
                    
                    if (!filtrosActivos) {
                        // CASO A: INICIO (Sin filtros)
                        // Solo mostramos las redes "VIP" (COMIREC y SIMATH)
                        if (ema.red === 'COMIREC' || ema.red === 'SIMATH') {
                            mostrar = true;
                        }
                    } else {
                        // CASO B: BUSCANDO (Con filtros)
                        // Mostramos TODO lo que coincida, sin importar la red
                        mostrar = true;
                    }
                }

                if (mostrar) {
                    const icon = (ema.status === 'online') ? iconOnline : iconOffline;
                    const marker = L.marker([ema.lat, ema.lon], { icon: icon });
                    
                    marker.bindTooltip(ema.nombre, { permanent: false, direction: 'top' });
                    marker.on('click', () => openPopup(marker, ema));
                    
                    markersLayer.addLayer(marker);
                    count++;
                }
            });

            lblCount.textContent = `Viendo ${count} estaciones`;
        }

        function openPopup(marker, ema) {
            const statusBadge = ema.status === 'online' 
                ? '<span class="badge bg-success">Online (Hoy)</span>' 
                : '<span class="badge bg-danger">Offline</span>';

            // Mostramos la Red en el popup para saber de dónde viene
            const popupContent = `
                <h6>${ema.nombre}</h6>
                <div class="mb-2">
                    <span class="badge bg-secondary">${ema.red}</span>
                    ${statusBadge}
                </div>
                <small class="d-block text-muted mb-2">${ema.descripcion}</small>
                <hr>
                <div class="d-grid gap-2">
                    <a href="/graficos?ema_id=${encodeURIComponent(ema.id)}" class="btn btn-primary btn-sm py-0">
                        <i class="bi bi-speedometer2"></i> Ver Dashboard
                    </a>
                </div>
            `;
            marker.bindPopup(popupContent).openPopup();
        }

        populateFilters();
        updateMap();

        triggers.forEach(t => t.addEventListener('change', updateMap));
    });
</script>
{% endblock %}