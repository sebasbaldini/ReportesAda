{% extends "base.html" %}

{% block title %}Página Principal - SIMPARH RECONQUISTA{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        #map {
            height: 600px !important; 
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 0.375rem; 
            margin-bottom: 2rem;
            background-color: #f0f0f0;
        }
        /* (Estilos para el popup) */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { font-size: 14px; line-height: 1.6; }
        .leaflet-popup-content h5 { font-weight: bold; margin-bottom: 5px; color: #333; }
        .leaflet-popup-content p { margin: 5px 0; color: #555; }
        .leaflet-popup-content hr { margin: 8px 0; }
        .popup-data { font-weight: bold; color: #0d6efd; }
        .popup-loading { font-style: italic; color: #888; }

        /* === NUEVO ESTILO: Etiquetas de nombre de las EMAs en el mapa === */
        .leaflet-tooltip.ema-label {
            background-color: transparent; /* Fondo transparente */
            border: none;                  /* Sin bordes */
            box-shadow: none;              /* Sin sombra cuadrada */
            font-weight: bold;             /* Texto en negrita */
            font-size: 12px;               /* Tamaño legible */
            color: #000;                   /* Color del texto (negro) */
            
            /* Borde blanco alrededor de las letras para que se lea bien sobre el mapa */
            text-shadow: 
                -1px -1px 0 #fff,  
                 1px -1px 0 #fff,
                -1px  1px 0 #fff,
                 1px  1px 0 #fff;
        }
    </style>
{% endblock %}


{% block content %}
    <div class="text-center pt-3 pb-4">
        <h1 class="display-4 fw-bold">SIMPARH RECONQUISTA</h1>
        <p class="lead text-muted">Plataforma de monitoreo y gestión de datos hidrometeorológicos.</p>
    </div>

    <div id="map" class="shadow-sm"></div>

    <div class="d-grid gap-3 d-md-flex justify-content-md-center mb-5">
        <a href="{{ url_for('main.report_page') }}" class="btn btn-primary btn-lg px-4 gap-3">
            <i class="bi bi-file-earmark-spreadsheet"></i>
            Imprimir Reportes
        </a>
        <a href="{{ url_for('main.chart_dashboard_page') }}" class="btn btn-outline-secondary btn-lg px-4">
            <i class="bi bi-graph-up"></i>
            Ver Gráficos
        </a>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        try {
            // === 1. Obtener datos de Flask ===
            const emaLocations = {{ ema_locations | tojson }};
            const currentDbKey = "{{ current_db_key }}"; // Obtenemos la DB actual
            
            console.log("EMAs recibidas:", emaLocations.length); 
            console.log("Base de datos actual:", currentDbKey);

            const owmApiKey = {{ owm_api_key | tojson }};
            const mapCenter = [-34.6, -58.8]; 
            const mapZoom = 10;
            
            const map = L.map('map').setView(mapCenter, mapZoom); 
            
            const baseMapLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            });

            const precipitationLayer = L.tileLayer(
                `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${owmApiKey}`, 
                {
                    attribution: '&copy; <a href="https://openweathermap.org/">OpenWeatherMap</a>',
                    opacity: 0.7 
                }
            );

            map.addLayer(baseMapLayer); 

            const baseMaps = { "Mapa Base (Claro)": baseMapLayer };
            const overlayMaps = { "Precipitación (Radar)": precipitationLayer };
            L.control.layers(baseMaps, overlayMaps).addTo(map);

            const greenDotIcon = L.divIcon({
                className: 'green-dot-icon',
                iconSize: [12, 12] 
            });
            
            const summaryApiUrl = "{{ url_for('main.get_dashboard_data', ema_id=0) }}";

            if (emaLocations && emaLocations.length > 0) {
                console.log("Datos encontrados. Dibujando marcadores...");
                emaLocations.forEach(ema => {
                    if (ema.lat && ema.lon) {
                        
                        const marker = L.marker([ema.lat, ema.lon], { 
                            icon: greenDotIcon,
                            ema_id: ema.id,
                            ema_nombre: ema.nombre,
                            ema_descripcion: ema.descripcion
                        });

                        // === LÓGICA DE ETIQUETA (TEXTO) ===
                        // Por defecto usamos el nombre
                        let labelText = ema.nombre;

                        // Si estamos en la DB principal (Reconquista), intentamos usar la descripción
                        if (currentDbKey === 'db_principal') {
                            labelText = ema.descripcion ? ema.descripcion : ema.nombre;
                        }

                        // === AGREGAR ETIQUETA PERMANENTE ===
                        marker.bindTooltip(labelText, {
                            permanent: true,       // Siempre visible
                            direction: 'top',      // Arriba del punto
                            className: 'ema-label',// Clase CSS definida arriba
                            offset: [0, -6]        // Pequeño ajuste vertical
                        });
                        
                        // === EVENTO CLICK (POPUP) ===
                        marker.on('click', function (e) {
                            const clickedMarker = e.target;
                            const emaId = clickedMarker.options.ema_id;
                            const emaNombre = clickedMarker.options.ema_nombre;
                            const emaDesc = clickedMarker.options.ema_descripcion;

                            let popupContent = `
                                <h5>${emaNombre}</h5>
                                <p>${emaDesc}</p>
                                <hr>
                                <p class="popup-loading">Cargando datos frescos...</p>
                            `;
                            
                            const popup = L.popup()
                                .setLatLng(e.latlng)
                                .setContent(popupContent)
                                .openOn(map);

                            fetch(summaryApiUrl.replace('0', emaId))
                                .then(response => response.json())
                                .then(data => {
                                    if (data.error) { throw new Error(data.error); }
                                    
                                    let finalHtml = `
                                        <h5>${emaNombre}</h5>
                                        <p>${emaDesc}</p>
                                        <hr>
                                    `;
                                    
                                    let dataFound = false;
                                    
                                    if (data.pluvio_sum_hoy) {
                                        finalHtml += `<p>Lluvia (Hoy): <span class="popup-data">${data.pluvio_sum_hoy.valor_str}</span></p>`;
                                        dataFound = true;
                                    }
                                    if (data.temperatura) {
                                        finalHtml += `<p>Temperatura: <span class="popup-data">${data.temperatura.valor_str}</span> <small>(${data.temperatura.timestamp})</small></p>`;
                                        dataFound = true;
                                    }
                                    if (data.nivel_max_hoy) {
                                        finalHtml += `<p>Nivel Máx. (Hoy): <span class="popup-data">${data.nivel_max_hoy.valor_str}</span></p>`;
                                        dataFound = true;
                                    }
                                    if (data.bateria) {
                                        finalHtml += `<p>Batería: <span class="popup-data">${data.bateria.valor_str}</span> <small>(${data.bateria.timestamp})</small></p>`;
                                        dataFound = true;
                                    }
                                    if (data.presion) {
                                        finalHtml += `<p>Presión: <span class="popup-data">${data.presion.valor_str}</span> <small>(${data.presion.timestamp})</small></p>`;
                                        dataFound = true;
                                    }
                                    
                                    if (!dataFound) {
                                        finalHtml += `<p class="popup-loading">No hay datos recientes (hoy) para esta estación.</p>`;
                                    }
                                    
                                    popup.setContent(finalHtml);
                                })
                                .catch(err => {
                                    console.error("Error al buscar summary de EMA:", err);
                                    popup.setContent(`
                                        <h5>${emaNombre}</h5>
                                        <p>${emaDesc}</p>
                                        <hr>
                                        <p style="color:red;">Error al cargar datos.</p>
                                    `);
                                });
                        });
                        marker.addTo(map);
                    }
                });
            } else { 
                console.warn("No se encontraron locaciones de EMAs (lista vacía). No se dibujarán marcadores."); 
            }
            
            if (!owmApiKey || owmApiKey.includes("AQUÍ_VA_TU_API_KEY")) {
                console.warn("API Key de OpenWeatherMap no configurada.");
            }

            setTimeout(function() { map.invalidateSize(); }, 100);

        } catch (e) {
            console.error("¡ERROR CATASTRÓFICO EN EL SCRIPT DEL MAPA!", e);
            const mapDiv = document.getElementById('map');
            if (e.message.includes("L is not defined")) {
                mapDiv.innerHTML = `<p style="color:red; padding: 20px;"><b>Error Crítico:</b> No se pudo cargar la librería del mapa (Leaflet.js). Revise el archivo <code>base.html</code>.</p>`;
            } else {
                mapDiv.innerHTML = `<p style="color:red; padding: 20px;">Error al cargar el mapa: ${e.message}</p>`;
            }
        }
    });
</script>

{% endblock %}