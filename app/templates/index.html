{% extends "base.html" %}

{% block title %}Mapa Interactivo - SIMPARH{% endblock %}

{% block map_filters %}
<div class="mt-2 border-top border-secondary pt-2">
    <h6 class="text-white small fw-bold mb-2 text-uppercase" style="font-size: 0.75rem;">
        <i class="bi bi-funnel"></i> Filtros
    </h6>

    <div class="mb-2">
        <label for="filter-tipo" class="text-white-50 small mb-0" style="font-size: 0.7rem;">Tipo</label>
        <select id="filter-tipo" class="form-select form-select-sm py-0" style="font-size: 0.8rem;">
            <option value="EMA" selected>Solo EMAs</option>
            <option value="MANUAL">Solo Aforos/Escalas</option>
            <option value="todas">Ver Todas</option>
        </select>
    </div>

    <div class="mb-2">
        <label for="filter-cuenca" class="text-white-50 small mb-0" style="font-size: 0.7rem;">Cuenca</label>
        <select id="filter-cuenca" class="form-select form-select-sm py-0" style="font-size: 0.8rem;">
            <option value="todas">Todas</option>
        </select>
    </div>

    <div class="mb-2">
        <label for="filter-partido" class="text-white-50 small mb-0" style="font-size: 0.7rem;">Partido</label>
        <select id="filter-partido" class="form-select form-select-sm py-0" style="font-size: 0.8rem;">
            <option value="todas">Todos</option>
        </select>
    </div>
</div>
{% endblock %}


{% block content %}
<style>
    @media (max-width: 768px) {
        .full-screen-map-container {
            height: calc(100vh - 60px) !important;
        }
    }
    .popup-custom .leaflet-popup-content-wrapper {
        border-radius: 8px; padding: 0; overflow: hidden;
    }
    .popup-custom .leaflet-popup-content {
        margin: 12px; width: 260px !important;
    }
</style>

<div class="full-screen-map-container">
    <div id="map" class="full-h"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const allEmas = {{ ema_locations | tojson }};
        const owmApiKey = {{ owm_api_key | tojson }};
        
        // URLs
        const urlDashboard = "{{ url_for('main.chart_dashboard_page') }}";
        const urlReporteAforos = "{{ url_for('main.report_aforos_page') }}";
        const urlReporteEscalas = "{{ url_for('main.report_escalas_page') }}";
        
        // Inicializar Mapa
        const map = L.map('map', { zoomControl: false }).setView([-34.6, -58.8], 9);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // Capas
        const baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
            attribution: '© OpenStreetMap, © CARTO' 
        });
        const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        });
        const rainLayer = L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${owmApiKey}`, { maxZoom: 18 });
        const cloudLayer = L.tileLayer(`https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${owmApiKey}`, { maxZoom: 18 });

        baseLayer.addTo(map);
        L.control.layers({ "Mapa Claro": baseLayer, "Satélite": satLayer }, { "Lluvia (OWM)": rainLayer, "Nubes (OWM)": cloudLayer }, { position: 'topright' }).addTo(map);

        // Iconos
        const createIcon = (color) => {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.4);"></div>`,
                iconSize: [14, 14],
                iconAnchor: [7, 7],
                popupAnchor: [0, -10]
            });
        };

        const iconOnline = createIcon('#198754'); // Verde (EMA Online)
        const iconOffline = createIcon('#dc3545'); // Rojo (EMA Offline)
        
        // --- NUEVOS COLORES ---
        const iconEscala = createIcon('#000000'); // Negro (Escalas)
        const iconAforo = createIcon('#0dcaf0');  // Celeste (Aforos)
        const iconOther = createIcon('#6c757d');  // Gris (Por defecto/Sin datos)  

        let markersLayer = L.layerGroup().addTo(map);

        // Popup Logic
        function openPopup(marker, ema) {
            let popupContent = `
                <div style="min-width: 220px;">
                    <h6 class="mb-1 fw-bold text-dark">${ema.nombre}</h6>
                    <small class="text-muted d-block mb-3 border-bottom pb-2">${ema.descripcion}</small>
            `;

            if (ema.is_ema) {
                const targetUrl = `${urlDashboard}?ema_id=${encodeURIComponent(ema.id)}`;
                popupContent += `
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-success me-2">EMA</span><small class="text-muted">Automática</small>
                    </div>
                    <div id="popup-sensors-list" class="mb-3 bg-light p-2 rounded">
                        <div class="text-center text-muted small"><span class="spinner-border spinner-border-sm"></span> Cargando...</div>
                    </div>
                    <div class="d-grid"><a href="${targetUrl}" class="btn btn-sm btn-primary"><i class="bi bi-speedometer2"></i> Dashboard</a></div>
                `;
                fetch(`/api/map-status/${encodeURIComponent(ema.id)}`)
                    .then(res => res.json())
                    .then(sensores => {
                        let htmlList = '<ul class="list-unstyled mb-0 small">';
                        if (sensores.length === 0) htmlList += '<li class="text-muted text-center">Sin sensores.</li>';
                        else sensores.forEach(s => {
                            const color = s.estado === 'online' ? 'text-success' : 'text-danger';
                            const icon = s.estado === 'online' ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
                            htmlList += `<li class="d-flex justify-content-between mb-1 border-bottom border-light pb-1"><span class="${color}"><i class="bi ${icon}"></i> ${s.nombre}</span><span class="fw-bold text-dark">${s.valor}</span></li>`;
                        });
                        htmlList += '</ul>';
                        const el = document.getElementById('popup-sensors-list');
                        if(el) el.innerHTML = htmlList;
                    }).catch(()=>{});
            } else {
                let hasData = false;
                if (ema.last_aforo) {
                    hasData = true;
                    popupContent += `
                        <div class="card border-0 bg-primary bg-opacity-10 mb-2 p-2">
                            <div class="d-flex align-items-center mb-1"><i class="bi bi-water text-primary me-2"></i><small class="fw-bold text-primary">Aforos (${ema.last_aforo})</small></div>
                            <a href="${urlReporteAforos}?ema_id=${ema.db_id}" class="btn btn-primary btn-sm w-100 py-0 small text-white">Descargar</a>
                        </div>`;
                }
                if (ema.last_escala) {
                    hasData = true;
                    popupContent += `
                        <div class="card border-0 bg-info bg-opacity-10 mb-2 p-2">
                            <div class="d-flex align-items-center mb-1"><i class="bi bi-ruler text-info me-2"></i><small class="fw-bold text-info">Escalas (${ema.last_escala})</small></div>
                            <a href="${urlReporteEscalas}?ema_id=${ema.db_id}" class="btn btn-info btn-sm w-100 py-0 small text-white">Descargar</a>
                        </div>`;
                }
                if (!hasData) popupContent += `<div class="alert alert-secondary small text-center p-2 mb-0">Sin datos recientes</div>`;
            }
            popupContent += `</div>`;
            L.popup({ className: 'popup-custom' }).setLatLng(marker.getLatLng()).setContent(popupContent).openOn(map);
        }

        // Render Map
       function updateMap() {
            markersLayer.clearLayers();
            const selTipo = document.getElementById('filter-tipo').value;
            const selCuenca = document.getElementById('filter-cuenca').value;
            const selPartido = document.getElementById('filter-partido').value;

            allEmas.forEach(ema => {
                // Filtros (Sin cambios)
                if (selTipo === 'EMA' && !ema.is_ema) return;
                if (selTipo === 'MANUAL' && ema.is_ema) return;
                if (selCuenca !== 'todas' && ema.cuenca !== selCuenca) return;
                if (selPartido !== 'todas' && ema.partido !== selPartido) return;

                // --- LÓGICA DE COLORES ACTUALIZADA ---
                let icon = iconOther; // Por defecto gris

                if (ema.is_ema) {
                    // Si es EMA: Verde o Rojo según estado
                    icon = (ema.status === 'online') ? iconOnline : iconOffline;
                } else {
                    // Si NO es EMA (Manuales):
                    if (ema.last_escala) {
                        icon = iconEscala; // Negro si tiene escala
                    } else if (ema.last_aforo) {
                        icon = iconAforo;  // Celeste si tiene aforo
                    }
                    // Si no tiene nada, se queda en gris (iconOther)
                }

                const marker = L.marker([ema.lat, ema.lon], { icon: icon });
                marker.on('click', () => { openPopup(marker, ema); });
                markersLayer.addLayer(marker);
            });
        }

        // Populate Filters
        function populateFilters() {
            const cuencas = new Set(), partidos = new Set();
            allEmas.forEach(e => {
                if(e.cuenca) cuencas.add(e.cuenca);
                if(e.partido) partidos.add(e.partido);
            });
            const fill = (id, set) => {
                const el = document.getElementById(id);
                [...set].sort().forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val; opt.textContent = val;
                    el.appendChild(opt);
                });
                el.addEventListener('change', updateMap);
            };
            fill('filter-cuenca', cuencas);
            fill('filter-partido', partidos);
            document.getElementById('filter-tipo').addEventListener('change', updateMap);
        }

        populateFilters();
        updateMap();
    });
</script>
{% endblock %}